name: Monitor Claude Code Releases

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-release:
    runs-on: ubuntu-24.04
    permissions:
      actions: write

    steps:
      - name: Check latest Claude Code release
        id: check
        run: |
          # Fetch package info from npm registry
          PACKAGE_INFO=$(curl -s https://registry.npmjs.org/@anthropic-ai/claude-code)

          # Get latest version and its publish time
          LATEST_VERSION=$(echo "$PACKAGE_INFO" | jq -r '.["dist-tags"].latest')
          PUBLISH_TIME=$(echo "$PACKAGE_INFO" | jq -r ".time[\"$LATEST_VERSION\"]")

          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "Error: Could not fetch latest version"
            exit 1
          fi

          echo "Latest version: $LATEST_VERSION"
          echo "Published at: $PUBLISH_TIME"

          # Calculate time difference in seconds
          PUBLISH_TIMESTAMP=$(date -d "$PUBLISH_TIME" +%s)
          CURRENT_TIMESTAMP=$(date +%s)
          TIME_DIFF=$((CURRENT_TIMESTAMP - PUBLISH_TIMESTAMP))
          HOURS_DIFF=$((TIME_DIFF / 3600))

          echo "Hours since release: $HOURS_DIFF"

          # Check if released in last 24 hours
          if [ $HOURS_DIFF -lt 24 ]; then
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "âœ“ New release detected within last 24 hours!"
          else
            echo "new_release=false" >> $GITHUB_OUTPUT
            echo "No new release in the last 24 hours"
          fi

      - name: Trigger Docker build
        if: steps.check.outputs.new_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker-build-push.yml',
              ref: 'main'
            });
            console.log('Triggered docker-build-push workflow for Claude Code version ${{ steps.check.outputs.version }}');
