# CodeMate Webhook - GitHub webhook receiver for issue-driven workflow
# Spawns Claude Code tmux sessions per issue automatically.
# Includes Cloudflare Tunnel for exposing the webhook endpoint.
#
# Build from repo root:
#   docker build -f docker/Dockerfile.webhook -t codemate-webhook .
ARG BASE_IMAGE=ghcr.io/boringhappy/codemate-base:latest
FROM ${BASE_IMAGE}

# Switch to root for setup operations
USER root

# Install cloudflared
RUN curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-main.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main" \
       > /etc/apt/sources.list.d/cloudflared.list \
    && apt-get update \
    && apt-get install -yy --no-install-recommends cloudflared \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy setup scripts as root (755 allows agent user to read/execute)
COPY --chmod=755 docker/setup /usr/local/bin/setup

# Copy webhook server and pyproject.toml to a known location
COPY --chown=agent:agent pyproject.toml webhook_server.py /home/agent/codemate-webhook/

# Switch to agent user and install Claude Code
USER agent
RUN curl -fsSL https://claude.ai/install.sh | bash

# Install webhook server Python dependencies via uv
RUN cd /home/agent/codemate-webhook && uv sync

# Create workspaces directory for per-issue/per-repo isolation
RUN mkdir -p /home/agent/workspaces

EXPOSE 8080

ENTRYPOINT ["/usr/local/bin/setup/setup-webhook.sh"]
CMD ["uv", "run", "--project", "/home/agent/codemate-webhook", "python", "/home/agent/codemate-webhook/webhook_server.py"]
