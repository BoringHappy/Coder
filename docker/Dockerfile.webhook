# CodeMate Webhook - GitHub webhook receiver for issue-driven workflow
# Spawns Claude Code tmux sessions per issue automatically.
#
# Build from repo root:
#   docker build -f docker/Dockerfile.webhook -t codemate-webhook .
ARG BASE_IMAGE=ghcr.io/boringhappy/codemate-base:latest
FROM ${BASE_IMAGE}

# Switch to root for setup operations
USER root

# Copy setup scripts as root (755 allows agent user to read/execute)
COPY --chmod=755 docker/setup /usr/local/bin/setup

# Copy webhook server and pyproject.toml to a known location
COPY --chown=agent:agent pyproject.toml /home/agent/codemate-webhook/
COPY --chown=agent:agent webhook_server/ /home/agent/codemate-webhook/webhook_server/

# Switch to agent user and install Claude Code
USER agent
RUN curl -fsSL https://claude.ai/install.sh | bash

# Install webhook server Python dependencies via uv
RUN cd /home/agent/codemate-webhook && uv sync --no-dev

# Create workspaces directory for per-issue/per-repo isolation
RUN mkdir -p /home/agent/workspaces

EXPOSE 8080

ENTRYPOINT ["/usr/local/bin/setup/setup-webhook.sh"]
CMD ["uv", "run", "--project", "/home/agent/codemate-webhook", "codemate-webhook"]
