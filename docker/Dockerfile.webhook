# CodeMate Webhook - GitHub webhook receiver for issue-driven workflow
# Spawns Claude Code tmux sessions per issue automatically.
# Can run locally (port-forwarded) or behind Cloudflare Tunnel.
ARG BASE_IMAGE=ghcr.io/boringhappy/codemate-base:latest
FROM ${BASE_IMAGE}

# Switch to root for setup operations
USER root

# Copy setup scripts as root (755 allows agent user to read/execute)
COPY --chmod=755 setup /usr/local/bin/setup

# Switch to agent user and install Claude Code
USER agent
RUN curl -fsSL https://claude.ai/install.sh | bash

# Install webhook server Python dependencies via uv
RUN cd /usr/local/bin/setup/python && uv sync

# Create workspaces directory for per-issue/per-repo isolation
RUN mkdir -p /home/agent/workspaces

EXPOSE 8080

ENTRYPOINT ["/usr/local/bin/setup/setup-webhook.sh"]
CMD ["uv", "run", "--project", "/usr/local/bin/setup/python", "python", "/usr/local/bin/setup/python/webhook_server.py"]
